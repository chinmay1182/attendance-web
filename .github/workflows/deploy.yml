name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }} # Or use key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e # Exit on error

            # Configuration based on CloudPanel settings
            APP_DIR="/home/myaccount/htdocs/myaccount.asia"
            CONTAINER_NAME="attendance-web"
            IMAGE_NAME="attendance-web"
            PORT=3001

            echo "Starting deployment to $APP_DIR..."

            # Check if directory exists
            if [ ! -d "$APP_DIR" ]; then
              echo "Directory $APP_DIR does not exist. Creating it..."
              mkdir -p $APP_DIR
            fi

            cd $APP_DIR

            # Pull latest changes
            echo "Pulling latest changes..."
            if [ -d ".git" ]; then
              git fetch origin master || git fetch --all
              git reset --hard origin/master
            else
              echo "Initializing git and cloning..."
              # Clone current directory . if empty, or else warn
              git clone git@github.com:chinmay1182/attendance-web.git .
            fi

            # Build and Start with Docker Compose
            echo "Starting Docker Compose..."

            # Ensure .env exists (or created from secrets if you were using secrets manager, 
            # but current script assumes file exists on server).
            if [ ! -f .env ]; then
              echo "Warning: .env file not found. App might fail."
            fi

            # Force cleanup old containers if they exist to prevent name conflicts
            if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
                echo "Removing existing container: $CONTAINER_NAME"
                docker rm -f $CONTAINER_NAME
            fi

            # Pull latest images (if using remote images) or force build
            docker compose down --remove-orphans || true
            docker compose up -d --build

            # Cleanup unused images
            echo "Cleaning up..."
            docker image prune -f

            echo "Deployment successful!"
